<?php
 namespace Optimization\Combine; use Boilerplate\DOMCrawler; use Boilerplate\Util\ArrayUtil; use Boilerplate\Util\CommonUtil; use Boilerplate\Util\StringUtil; use Boilerplate\Util\ThemeUtil; use DOMElement; use Optimization\Data\Source; use Optimization\Notice; use Optimization\Util\Util; class Combine extends Common { const ASSETS_REGEX = "\57\165\162\154\x5c\x73\52\134\x28\x5c\x73\x2a\x28\x3f\41\x5b\42\x27\x5d\x3f\144\141\164\141\x3a\x29\50\x3f\x21\x5b\47\174\134\42\x5d\x3f\133\134\43\174\x5c\45\174\135\51\x28\x5b\x5e\51\135\53\51\134\163\52\x5c\x29\50\133\x5e\x3b\x7d\x2c\134\163\x5d\x2a\51\57\x69"; public function __construct() { goto eImfY; lCzbG: parent::__construct(); goto nCJxe; nCJxe: xFLIK: goto GuJH1; eImfY: if (!$this->loadConstant()) { goto xFLIK; } goto lCzbG; GuJH1: } public function addFilters() : self { $this->addFilter("\x6f\160\x74\151\x6d\x69\x7a\x61\x74\x69\x6f\156\x5f\142\165\x66\x66\145\162\x5f\160\162\157\x63\145\x73\x73", [$this, "\155\141\x79\x62\145\x49\156\151\x74\120\162\x6f\x63\145\x73\x73"]); return parent::addFilters(); } public function loadConstant() { goto RHcWi; Z2yCf: return $return; goto yBt26; D4yah: e1t4v: goto idUNl; pP3f4: MIaAG: goto Z2yCf; AcWIu: $return = $this->getFilesystem()->mkdir(OPTIMIZATION_COMBINE_PATH); goto pP3f4; idUNl: define("\x4f\x50\124\x49\115\x49\x5a\x41\x54\x49\117\116\x5f\103\117\x4d\102\x49\x4e\x45\137\120\x41\x54\110", "{$path}\x2f\143\157\x6d\142"); goto AcWIu; VoHL7: goto MIaAG; goto D4yah; I2Dpe: Notice::warning(sprintf(__("\x25\163\x20\x63\x6f\156\x73\x74\x61\156\x74\x20\x6e\x6f\164\40\144\145\146\151\156\145\144\54\40\x70\154\x65\141\163\x65\40\x64\145\146\151\156\x65\x20\x74\150\141\x74\40\x69\x6e\x20\x77\160\x2d\x63\157\156\146\x69\x67\x2e\x70\150\160\x2e", OPTIMIZATION_DOMAIN), "\74\x63\157\x64\x65\76\x57\120\x5f\103\x41\x43\x48\x45\x5f\x50\101\124\x48\74\x2f\x63\157\144\145\76")); goto VoHL7; ZzhTD: if ($path = Util::getConstant("\127\120\x5f\x43\101\103\110\x45\137\120\x41\124\110")) { goto e1t4v; } goto I2Dpe; RHcWi: $return = false; goto ZzhTD; yBt26: } public function rewriteAssets($content, $src) { goto UixlM; Oi2II: K8vor: goto lPy05; EMfBM: if (!(is_array($matches) && $matches)) { goto g3aQV; } goto Zl9la; Za_n6: preg_match_all(self::ASSETS_REGEX, $content, $matches); goto EMfBM; arQt_: FQ1TM: goto UqdZ3; GIm3e: $content = $this->replaceAssets($content, $find); goto arQt_; s5ikS: if (!($root && $src)) { goto FQ1TM; } goto bp04M; bp04M: $srcPath = $root . trailingslashit(dirname(str_replace($siteUrl, '', $src))); goto ysie0; Zl9la: foreach ($matches[1] as $original) { goto edUcP; tPtwN: sBvNr: goto nS_oi; edUcP: $url = trim($original, "\40\11\xa\15\x0\13\42\47"); goto jIRiD; jIRiD: $realpath = realpath("{$srcPath}{$url}"); goto f_9p0; vDicD: sYJDI: goto tPtwN; vFf00: $find[$original] = "\57\x2f" . str_replace($root, $host, $realpath); goto vDicD; f_9p0: if (!$realpath) { goto sYJDI; } goto vFf00; nS_oi: } goto Oi2II; cUjAh: $host = ArrayUtil::get(wp_parse_url($siteUrl), "\150\157\163\164"); goto Za_n6; lPy05: g3aQV: goto GIm3e; ysie0: $find = []; goto cUjAh; dqjXH: $siteUrl = site_url(); goto s5ikS; UixlM: $root = untrailingslashit(CommonUtil::getConstant("\101\x42\x53\x50\101\124\110")); goto dqjXH; UqdZ3: return $content; goto qtaDJ; qtaDJ: } public function replaceAssets($content, $replacements = array()) { goto YAv05; t7Svk: array_multisort($keys, SORT_DESC, $replacements); goto WUUWd; QOhex: return $content; goto YHmAj; WUUWd: $content = str_replace(array_keys($replacements), array_values($replacements), $content); goto AhOQy; YAv05: if (!$replacements) { goto OquhK; } goto uCWoZ; AhOQy: OquhK: goto QOhex; uCWoZ: $keys = array_map("\163\x74\x72\x6c\145\x6e", array_keys($replacements)); goto t7Svk; YHmAj: } public function maybeInitProcess($buffer) { $buffer = $this->combineFiles($buffer, "\154\x69\x6e\153\133\150\x72\x65\146\135\x5b\162\145\x6c\x3d\163\x74\x79\154\145\163\x68\x65\x65\x74\135", "\x6c\x69\156\153", "\150\162\145\146"); return $buffer; } public function combineSources($sources) { goto y6WPD; N66jy: foreach ($sources as $source) { goto gk0wn; hbjQb: bvNlf: goto ABiTY; xIEB0: $content = $filesystem->getContent($path); goto hfwLF; HnjWy: $contents = array_merge($this->combineSources($source->getDependencies()), $contents); goto p7b2I; A30EE: aDJgT: goto hbjQb; gk0wn: if (!$source instanceof Source) { goto bvNlf; } goto RZKqE; ABiTY: Yjn_6: goto gIciB; TKNal: if (!$source->getDependencies()) { goto pJRIK; } goto HnjWy; RZKqE: $path = $source->getPath(); goto xIEB0; q7dKk: $contents[$source->getHandle()] = $content; goto TKNal; hfwLF: if (!$content) { goto aDJgT; } goto I_aUm; p7b2I: pJRIK: goto A30EE; i4MXH: $source->setCombined(true); goto q7dKk; I_aUm: $content = $this->rewriteAssets($content, $source->getUrl()); goto i4MXH; gIciB: } goto J9dbI; y6WPD: $contents = []; goto vodHr; yJHZC: return $contents; goto b6JX0; J9dbI: dZcx4: goto yJHZC; vodHr: $filesystem = $this->getFilesystem(); goto N66jy; b6JX0: } public function isCombined($filepath) : bool { return $this->getFilesystem()->exists($filepath); } public function getFilePath($filename, $type) : string { $path = CommonUtil::getConstant("\x4f\x50\124\111\115\111\x5a\x41\x54\111\117\x4e\x5f\x43\x4f\x4d\102\111\x4e\105\x5f\x50\101\124\x48"); return "{$path}\x2f{$type}\57{$filename}\56{$type}"; } public function combineFiles($buffer, $selector, $element, $attr) { goto ObyDv; HY4FP: goto q3BVd; goto AN818; kwop6: $buffer = DOMCrawler::elementsMap($buffer, $selector, function (DOMElement $node) use(&$sources, $attr) { goto R0F12; yQUmI: $pathInfo = $this->getSourcePath($source); goto H4Ucm; J76hC: $sources[basename($path)] = (new Source())->setUrl($source)->setPath($path)->setType($node->nodeName)->setHandle($node->getAttribute("\x69\x64")); goto t81BL; t81BL: $node->parentNode->removeChild($node); goto jjVMU; t8T6h: $path = str_replace($pathInfo["\160\141\x74\150\x5f\165\162\154"], $pathInfo["\x70\x61\164\150"], $source); goto J76hC; jjVMU: n9bYO: goto mgZmt; mgZmt: return $node; goto jvUvp; R0F12: $source = remove_query_arg("\x76\145\x72", $node->getAttribute($attr)); goto yQUmI; H4Ucm: if (!$pathInfo) { goto n9bYO; } goto t8T6h; jvUvp: }); goto ytH7H; ytH7H: $type = $element == "\x6c\x69\x6e\x6b" ? "\x63\x73\163" : "\152\163"; goto WNFUf; yostV: $buffer = StringUtil::replaceFirst("\74\x2f\150\145\141\144\76", "{$combined}\74\57\150\x65\x61\144\76", $buffer); goto OVluU; L2oqx: $combined = ThemeUtil::generateElement($element, $attrs); goto yostV; hDm3v: T4wgq: goto ZuOSB; HXM4v: $attrs["\162\145\154"] = "\x73\x74\x79\x6c\145\163\x68\145\145\x74"; goto J5Njp; ObyDv: $sources = []; goto kwop6; QCJGc: $contents = $this->combineSources($sources); goto LnuqP; p_6Wb: $attrs["\x64\145\146\146\x65\162"] = true; goto HY4FP; eGyI6: $attrs = ["\x69\x64" => "\x63\157\155\142\x69\156\x65\144\55{$type}", $attr => str_replace(CommonUtil::getConstant("\101\102\123\x50\101\x54\110"), trailingslashit(site_url()), $filepath)]; goto sNG6Z; J5Njp: q3BVd: goto L2oqx; bPyQ3: if ($this->isCombined($filepath)) { goto luZ9Z; } goto QCJGc; LnuqP: if (!$contents) { goto T4wgq; } goto DFznu; gGppT: return $buffer; goto XtiSl; sNG6Z: if ($type == "\143\163\163") { goto hL59D; } goto de3_N; usybY: $combined = $this->getFilesystem()->putContent($filepath, $contents); goto hDm3v; AN818: hL59D: goto HXM4v; l5jTL: $filepath = $this->getFilePath($filename, $type); goto MohvP; de3_N: $attrs["\x61\x73\171\x6e\x63"] = true; goto p_6Wb; OVluU: wLZDH: goto gGppT; DFznu: $contents = $this->applyFilters("\x6f\x70\x74\151\x6d\151\172\x61\164\151\157\156\137\155\x69\x6e\x69\146\x79\137{$type}", implode('', $contents), $filepath); goto usybY; WNFUf: $filename = md5(implode('', array_keys($sources))); goto l5jTL; MohvP: $combined = true; goto bPyQ3; ZuOSB: luZ9Z: goto rpBAN; rpBAN: if (!$combined) { goto wLZDH; } goto eGyI6; XtiSl: } }
