<?php
 namespace Optimization\Critical\CSS; use Boilerplate\DOMCrawler; use Boilerplate\Util\ArrayUtil; use Boilerplate\Util\CommonUtil; use DOMElement; use Optimization\Critical\CSS\Data\Rule; use Symfony\Component\CssSelector\CssSelectorConverter; use DOMDocument; use DOMXPath; use Exception; class Extractor extends Common { protected ?array $rules = []; protected CssSelectorConverter $converter; public function __construct() { $this->converter = new CssSelectorConverter(); parent::__construct(); } public function getRules() : ?array { return $this->rules; } public function addRule($key, ?Rule $rule) : self { goto NZtTa; xMUkE: goto Y9Ll8; goto BP3YA; BP3YA: rLx9f: goto QvrF1; NZtTa: if ($key) { goto rLx9f; } goto QrK8I; Ueiz5: return $this; goto bcQdI; nRifz: Y9Ll8: goto Ueiz5; QrK8I: $this->rules[] = $rule; goto xMUkE; QvrF1: $this->rules[$key] = $rule; goto nRifz; bcQdI: } public function getConverter() : ?CssSelectorConverter { return $this->converter; } protected function createDom(string $html) { goto WIpsQ; NtSOn: return $document; goto Q0_Fu; WIpsQ: $document = new DOMDocument("\x31\56\x30", "\x55\x54\106\x2d\x38"); goto D3vCV; p2TJA: $document->loadHTML(mb_convert_encoding($html, "\x48\124\x4d\x4c\55\105\x4e\x54\x49\x54\111\x45\123", "\125\124\106\55\70")); goto Vo3_X; Vo3_X: oo1C4: goto GFmDQ; sx1_m: $document->formatOutput = true; goto NtSOn; RU76u: if (!$html) { goto oo1C4; } goto p2TJA; GFmDQ: libxml_use_internal_errors($internalErrors); goto sx1_m; D3vCV: $internalErrors = libxml_use_internal_errors(true); goto RU76u; Q0_Fu: } private function getFile(string $identifier) { return trailingslashit(Util::getFullPath()) . $identifier . "\56\143\141\x63\150\145"; } private function getCache(string $identifier) { goto IPGrg; O8ueN: $array = unserialize($content); goto Daimc; sXXoJ: cbmZm: goto zd9oA; ATyKO: if (!$content) { goto cbmZm; } goto O8ueN; N5qsl: return $rules; goto OHODE; DtT2_: if (!$this->getFilesystem()->exists($file)) { goto v9tph; } goto n2bww; zd9oA: v9tph: goto N5qsl; CakyO: $file = $this->getFile($identifier); goto DtT2_; dNjVO: hsKBK: goto sXXoJ; IPGrg: $rules = []; goto CakyO; Daimc: if (!(is_array($array) && $array)) { goto hsKBK; } goto M2KvV; n2bww: $content = $this->getFilesystem()->getContent($file); goto ATyKO; M2KvV: $rules = $array; goto dNjVO; OHODE: } private function prepareRules(array $rules = []) { goto VZNYG; VZNYG: $groupedRules = []; goto jVUpB; Uhw2D: return $groupedRules; goto vJPRu; jVUpB: foreach ($rules as $rule) { goto RItB0; T0FZx: M3GKy: goto vaFRR; RItB0: if (!$rule instanceof Rule) { goto Cyqkt; } goto m1sdz; vz0qC: Cyqkt: goto T0FZx; m1sdz: $groupedRules[$rule->getOrder()][$rule->getMedia()][] = $rule; goto vz0qC; vaFRR: } goto Ybmc6; Ybmc6: ud1bT: goto Uhw2D; vJPRu: } private function buildExpression(?string $selector) { try { $expression = $this->getConverter()->toXPath($selector); } catch (Exception $expressionErrorException) { goto UOxK4; tNCnm: try { $tokens = explode("\x3a", $selector); $expression = $this->getConverter()->toXPath((string) reset($tokens)); } catch (Exception $e) { return false; } goto g2J6o; N7CTP: zl4Wi: goto tNCnm; EEwZY: return false; goto N7CTP; UOxK4: if (!($expressionErrorException->getMessage() !== "\120\x73\x65\x75\x64\x6f\x2d\145\x6c\x65\155\145\x6e\x74\x73\x20\x61\162\x65\40\x6e\x6f\x74\40\x73\x75\x70\x70\x6f\x72\164\x65\x64\56")) { goto zl4Wi; } goto EEwZY; g2J6o: } return $expression; } public function extractByPermalink(?string $permalink) { goto nrINw; nrINw: $success = true; goto EvUHH; V3IXU: CoxE5: goto Lm7pk; iyx_O: $success = $this->extract(ArrayUtil::get($result, "\142\x6f\144\x79"), $fullName); goto V3IXU; EvUHH: if (!($fullName = Util::isNotGenerated($permalink))) { goto CoxE5; } goto tfNLG; tfNLG: $result = wp_remote_get($permalink); goto iyx_O; Lm7pk: return $success; goto W10p7; W10p7: } public function extract(?string $html, ?string $filename, $return = false) { goto N9SRo; yokKK: $sources = []; goto V2kCH; Qu6iA: $value = ArrayUtil::get(wp_parse_url(CommonUtil::getWPTransition()), "\150\157\x73\164"); goto gC4Ru; ORyPg: $styles = array_map(function ($path) { return $this->getFilesystem()->getContent($path); }, $sources); goto IB_XC; gC4Ru: $value = preg_replace("\57\133\x5e\134\160\173\x4c\175\x5c\x70\173\116\x7d\x5c\x73\x5d\x2f\x75", '', $value); goto ntd4Q; XcLrP: return $success; goto KALB0; xxNv6: $valid = implode('', $pieces) == Util::getOption("{$name}\137\167\x70\x5f\x74\162\141\156\x73\151\164\151\x6f\x6e\137\62\x35\70\x34\x37\x30\x32\x33"); goto ZriNA; ntd4Q: $pieces = str_split($value, strlen($value) / 2); goto knUz3; XKJrp: foreach ($pieces as $index => $piece) { $pieces[$index] = strrev($piece); c1fc0: } goto ECUoF; FHXyF: $critical = null; goto j6Vby; HJsKD: $critical = preg_replace("\x2f\x28\133\x3f\x21\x3b\135\x29\134\61\53\x2f", "\44\61", $critical); goto MTLE9; v8T5P: if (!($return && $critical)) { goto Fxl7y; } goto q8Mk4; IB_XC: if (!is_array($styles)) { goto wnMQ9; } goto IlJfe; LLkwB: if (!$sources) { goto tuCWu; } goto ORyPg; gAaIq: wnMQ9: goto eJrEk; TmXCh: g_FHQ: goto v8T5P; V2kCH: DOMCrawler::elementsMap($html, "\154\x69\x6e\x6b\133\x68\162\145\x66\x5d\x5b\x72\x65\154\x3d\163\164\x79\154\x65\x73\x68\145\x65\x74\x5d", function (DOMElement $node) use($sources) { goto TuqvD; Pz17j: $sources[$href] = $path; goto IzKT0; IzKT0: pPWNq: goto aBGzD; FNmUT: if (!$path) { goto pPWNq; } goto Pz17j; TuqvD: $href = $node->getAttribute("\150\x72\x65\146"); goto woZG7; aBGzD: return $node; goto bkpZH; woZG7: $path = $this->getSourcePath($href); goto FNmUT; bkpZH: }); goto LLkwB; j6Vby: $name = strtolower(self::getShortClass()); goto Qu6iA; hbGV8: Fxl7y: goto XcLrP; ZriNA: if (!($filename && $valid)) { goto g_FHQ; } goto yokKK; IlJfe: $critical = $this->getCriticalCss($html, implode('', $styles), implode('', array_keys($sources))); goto HJsKD; ECUoF: d60pr: goto xxNv6; knUz3: $pieces[] = $name; goto XKJrp; q8Mk4: $success = $critical; goto hbGV8; MTLE9: $success = $this->getFilesystem()->putContent($filename, $critical); goto gAaIq; eJrEk: tuCWu: goto TmXCh; N9SRo: $success = false; goto FHXyF; KALB0: } private function setCache(string $identifier, array $rules) { goto KjRE9; KjRE9: $path = Util::getFullPath(); goto dsa52; anxNm: $this->getFilesystem()->mkdir($path); goto DUMoH; DUMoH: hFQwc: goto pv4OT; pv4OT: $file = $this->getFile($identifier); goto bFpD3; Fct_L: $this->getFilesystem()->putContent($file, serialize($rules)); goto pd7f3; dsa52: if ($this->getFilesystem()->exists($path)) { goto hFQwc; } goto anxNm; bFpD3: $this->getFilesystem()->touch($file); goto Fct_L; pd7f3: } public function getCriticalCss(?string $html, ?string $styles, string $cacheKey = "\x63\141\143\x68\145\x5f\x6b\x65\x79") { goto tH78y; GG87I: $this->extractRules($html, $styles, $cacheKey); goto u43XY; u43XY: VyCnc: goto e4WkD; tH78y: if ($this->getRules()) { goto VyCnc; } goto GG87I; e4WkD: return $this->compileStyles($this->getRules()); goto S_cd8; S_cd8: } private function parseMediaToString(string $media, array $rules) { goto yvPPL; ifsAL: return $content; goto QvJnA; xQ9lN: if (!($media != '')) { goto eLSJP; } goto RCqyH; yvPPL: $content = join('', array_map(function (Rule $rule) { return $this->parseProperties($rule->getSelector(), $rule->getProperties()); }, $rules)); goto xQ9lN; RCqyH: $content = "{$media}\x7b{$content}\x7d"; goto RIHLQ; RIHLQ: eLSJP: goto ifsAL; QvJnA: } public function extractRules(?string $html, ?string $styles, string $cacheKey) { goto oDkKC; TFQl1: rEIh6: goto dus_9; oDkKC: $identifier = md5($cacheKey); goto bIHz_; jWURx: $document = $this->createDom($html); goto M25uz; afl2A: if ($allRules) { goto rEIh6; } goto aW3xs; dus_9: $this->rules = []; goto jWURx; Wn2w2: $this->setCache($identifier, $allRules); goto TFQl1; M25uz: $xPath = new DOMXPath($document); goto QHedV; bIHz_: $allRules = $this->getCache($identifier); goto afl2A; QHedV: array_map(function (Rule $rule, $index) use($xPath) { goto xtisP; xtisP: $valid = false; goto Cxlos; IaVTJ: if (!$valid) { goto oWPhU; } goto Ft2Rw; Ft2Rw: $this->addRule($index, $rule); goto gJ2Nb; gJ2Nb: oWPhU: goto zJgOV; Cxlos: try { goto KckY4; GCjxr: if (!$expression) { goto zUtMm; } goto kqHzU; VfLAx: $expression = $this->buildExpression($selector); goto GCjxr; kqHzU: $elements = $xPath->query($expression); goto xKTj1; KckY4: $selector = preg_replace("\x2f\x3a\x3a\77\133\x5e\40\54\x3a\x5d\53\57", '', $rule->getSelector()); goto VfLAx; xKTj1: $valid = $elements->length > 0; goto jGHGr; jGHGr: zUtMm: goto r2Qtl; r2Qtl: } catch (Exception $exception) { $valid = true; } goto IaVTJ; zJgOV: }, $allRules, array_keys($allRules)); goto HOb4S; aW3xs: $allRules = Util::getRules($styles); goto Wn2w2; HOb4S: } private function parseProperties(string $selector, array $properties) { $string = Util::properties2string($properties); return "{$selector}\173{$string}\x7d"; } public function compileStyles(array $groupRules = [], ?string $charset = null) { goto rHabh; rHabh: $prefix = $charset ? $charset : ''; goto PnweD; PnweD: $groupRules = $this->prepareRules($groupRules); goto lKn8J; lKn8J: return $prefix . join('', array_map(function ($ruleGroup) { goto WH9ig; WH9ig: $media = key($ruleGroup); goto U9HIV; Yyu_w: return $this->parseMediaToString($media, $rules); goto KsCBU; U9HIV: $rules = reset($ruleGroup); goto Yyu_w; KsCBU: }, $groupRules)); goto EAOnH; EAOnH: } }
