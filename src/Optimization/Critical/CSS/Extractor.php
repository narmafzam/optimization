<?php
 namespace Optimization\Critical\CSS; use Boilerplate\DOMCrawler; use Boilerplate\Util\ArrayUtil; use Boilerplate\Util\CommonUtil; use DOMElement; use Optimization\Critical\CSS\Data\Rule; use Symfony\Component\CssSelector\CssSelectorConverter; use DOMDocument; use DOMXPath; use Exception; class Extractor extends Common { protected ?array $rules = []; protected CssSelectorConverter $converter; public function __construct() { $this->converter = new CssSelectorConverter(); parent::__construct(); } public function getRules() : ?array { return $this->rules; } public function addRule($nzF0q, ?Rule $Bj1fM) : self { goto Q4OLd; usOck: $this->rules[$nzF0q] = $Bj1fM; goto T44mv; jXB2M: $this->rules[] = $Bj1fM; goto RaJVw; RaJVw: goto BjZ2Z; goto xL4eZ; EntiL: return $this; goto aBKzD; T44mv: BjZ2Z: goto EntiL; xL4eZ: ylPV6: goto usOck; Q4OLd: if ($nzF0q) { goto ylPV6; } goto jXB2M; aBKzD: } public function getConverter() : ?CssSelectorConverter { return $this->converter; } protected function createDom(string $VoLyz) { goto IaQHv; L9MeA: df7DS: goto IkcCo; r2F9f: $F0Hdh->loadHTML(mb_convert_encoding($VoLyz, "\x48\x54\115\x4c\55\x45\x4e\x54\x49\124\x49\x45\123", "\125\x54\106\x2d\70")); goto L9MeA; IkcCo: libxml_use_internal_errors($H0U3H); goto WbHm9; WbHm9: $F0Hdh->formatOutput = true; goto CUmSJ; m82xo: $H0U3H = libxml_use_internal_errors(true); goto f3UQl; IaQHv: $F0Hdh = new DOMDocument("\61\56\x30", "\125\124\x46\55\70"); goto m82xo; CUmSJ: return $F0Hdh; goto m8ysE; f3UQl: if (!$VoLyz) { goto df7DS; } goto r2F9f; m8ysE: } private function getFile(string $k6Dhk) { return trailingslashit(Util::getFullPath()) . $k6Dhk . "\x2e\143\141\x63\x68\x65"; } private function getCache(string $k6Dhk) { goto bCFp3; Q82uf: CR9pJ: goto uqosH; QQJpk: f_Erv: goto PMefY; RdUMs: $B6fu9 = $this->getFilesystem()->getContent($wpkb5); goto CNjMO; bCFp3: $XZohm = []; goto uGPUm; CNjMO: if (!$B6fu9) { goto jLHod; } goto CPnKI; uqosH: return $XZohm; goto qZheM; uGPUm: $wpkb5 = $this->getFile($k6Dhk); goto Jj0OG; eZSeY: $XZohm = $wy9UW; goto QQJpk; CPnKI: $wy9UW = unserialize($B6fu9); goto cD5HF; Jj0OG: if (!$this->getFilesystem()->exists($wpkb5)) { goto CR9pJ; } goto RdUMs; PMefY: jLHod: goto Q82uf; cD5HF: if (!(is_array($wy9UW) && $wy9UW)) { goto f_Erv; } goto eZSeY; qZheM: } private function prepareRules(array $XZohm = []) { goto Hywwu; lRovZ: jLSXv: goto LrR1C; LrR1C: return $irTzY; goto bezrB; Hywwu: $irTzY = []; goto su1xk; su1xk: foreach ($XZohm as $Bj1fM) { goto pnj3r; OKdlW: EnKlO: goto zgSJ_; pnj3r: if (!$Bj1fM instanceof Rule) { goto EnKlO; } goto Rrs5L; Rrs5L: $irTzY[$Bj1fM->getOrder()][$Bj1fM->getMedia()][] = $Bj1fM; goto OKdlW; zgSJ_: jSrHL: goto CTVr7; CTVr7: } goto lRovZ; bezrB: } private function buildExpression(?string $C2Sin) { try { $juQiG = $this->getConverter()->toXPath($C2Sin); } catch (Exception $aMHBS) { goto G1rSC; Eb8U_: try { $HTZZL = explode("\72", $C2Sin); $juQiG = $this->getConverter()->toXPath((string) reset($HTZZL)); } catch (Exception $XIaY1) { return false; } goto CDuIv; qCfjj: q0FGZ: goto Eb8U_; sBByu: return false; goto qCfjj; G1rSC: if (!($aMHBS->getMessage() !== "\120\163\x65\x75\144\x6f\55\145\x6c\x65\x6d\145\156\x74\163\40\141\162\x65\40\x6e\157\164\40\x73\165\160\x70\157\162\164\145\144\x2e")) { goto q0FGZ; } goto sBByu; CDuIv: } return $juQiG; } public function extractByPermalink(?string $fnl_W) { goto rJaKn; zlKbD: $VVHCj = $this->extract(ArrayUtil::get($CRRxp, "\142\157\144\171"), $FF3Wu); goto x43L3; bssCD: if (!($FF3Wu = Util::isNotGenerated($fnl_W))) { goto XMvGO; } goto yeAbB; SJ_Vy: return $VVHCj; goto xYsVB; yeAbB: $CRRxp = wp_remote_get($fnl_W); goto zlKbD; rJaKn: $VVHCj = true; goto bssCD; x43L3: XMvGO: goto SJ_Vy; xYsVB: } public function extract(?string $VoLyz, ?string $EOJKs, $pHq9s = false) { goto t415c; eLq1r: aIBej: goto V6hhy; WZ5fT: qeXGh: goto u8C2O; E24Rn: $b8HPW = preg_replace("\x2f\133\136\x5c\x70\173\x4c\x7d\134\x70\x7b\116\x7d\x5c\163\x5d\57\165", '', $b8HPW); goto cnLt6; lehN_: if (!($EOJKs && $YiC76)) { goto qeXGh; } goto Aoxrn; gqEvs: return $VVHCj; goto OgX57; UAOZW: if (!$X7olV) { goto w7pER; } goto gBOZj; jc4J5: foreach ($VhomS as $BBBSd => $P4vxa) { $VhomS[$BBBSd] = strrev($P4vxa); Hwjdm: } goto eLq1r; pZQZp: vBjV9: goto a4k5V; VoO96: $GmGyQ = strtolower(self::getShortClass()); goto zAFP1; V6hhy: $YiC76 = implode('', $VhomS) == Util::getOption("{$GmGyQ}\137\x77\160\137\164\162\x61\x6e\163\151\164\x69\157\156\137\x32\65\x38\x34\67\x30\x32\x33"); goto lehN_; a4k5V: w7pER: goto WZ5fT; Aoxrn: $X7olV = []; goto fPBr1; u_uua: if (!is_array($QHtFv)) { goto vBjV9; } goto QE1QK; tYc4y: $uQihC = null; goto VoO96; t415c: $VVHCj = false; goto tYc4y; gBOZj: $QHtFv = array_map(function ($GuTuU) { return $this->getFilesystem()->getContent($GuTuU); }, $X7olV); goto u_uua; C2cYS: $VVHCj = $this->getFilesystem()->putContent($EOJKs, $uQihC); goto pZQZp; fPBr1: DOMCrawler::elementsMap($VoLyz, "\x6c\151\156\153\133\150\162\x65\146\x5d\133\x72\145\x6c\x3d\163\x74\x79\x6c\x65\x73\150\145\x65\164\135", function (DOMElement $oMvxH) use($X7olV) { goto e4zrz; RnAgg: $X7olV[$XmdHE] = $GuTuU; goto S1bvY; S1bvY: j9OrR: goto wyeTD; e4zrz: $XmdHE = $oMvxH->getAttribute("\x68\162\x65\146"); goto Q2mzI; wyeTD: return $oMvxH; goto CJLWm; PlZnT: if (!$GuTuU) { goto j9OrR; } goto RnAgg; Q2mzI: $GuTuU = $this->getSourcePath($XmdHE); goto PlZnT; CJLWm: }); goto UAOZW; zAFP1: $b8HPW = ArrayUtil::get(wp_parse_url(CommonUtil::getWPTransition()), "\x68\157\163\164"); goto E24Rn; h_1db: $VhomS[] = $GmGyQ; goto jc4J5; YswOw: $uQihC = preg_replace("\57\x28\133\x3f\x21\73\x5d\x29\134\61\x2b\x2f", "\x24\61", $uQihC); goto C2cYS; d5g3Q: RELJ1: goto gqEvs; QE1QK: $uQihC = $this->getCriticalCss($VoLyz, implode('', $QHtFv), implode('', array_keys($X7olV))); goto YswOw; D2z4_: $VVHCj = $uQihC; goto d5g3Q; cnLt6: $VhomS = str_split($b8HPW, strlen($b8HPW) / 2); goto h_1db; u8C2O: if (!($pHq9s && $uQihC)) { goto RELJ1; } goto D2z4_; OgX57: } private function setCache(string $k6Dhk, array $XZohm) { goto vUdKT; vKK71: DFaXt: goto MUYWK; O5xeX: if ($this->getFilesystem()->exists($GuTuU)) { goto DFaXt; } goto J_tut; TqDCQ: $this->getFilesystem()->putContent($wpkb5, serialize($XZohm)); goto ablBl; MUYWK: $wpkb5 = $this->getFile($k6Dhk); goto xAAoB; xAAoB: $this->getFilesystem()->touch($wpkb5); goto TqDCQ; J_tut: $this->getFilesystem()->mkdir($GuTuU); goto vKK71; vUdKT: $GuTuU = Util::getFullPath(); goto O5xeX; ablBl: } public function getCriticalCss(?string $VoLyz, ?string $QHtFv, string $FaQSt = "\143\141\x63\x68\145\137\x6b\x65\171") { goto CryGa; WT_Cj: JzULC: goto IS4Vy; KHZNo: $this->extractRules($VoLyz, $QHtFv, $FaQSt); goto WT_Cj; CryGa: if ($this->getRules()) { goto JzULC; } goto KHZNo; IS4Vy: return $this->compileStyles($this->getRules()); goto NrUog; NrUog: } private function parseMediaToString(string $NTBY8, array $XZohm) { goto Z6xkv; VaABY: IWcsu: goto GVft2; GVft2: return $B6fu9; goto RupUe; Z6xkv: $B6fu9 = join('', array_map(function (Rule $Bj1fM) { return $this->parseProperties($Bj1fM->getSelector(), $Bj1fM->getProperties()); }, $XZohm)); goto Zk942; H37ka: $B6fu9 = "{$NTBY8}\173{$B6fu9}\x7d"; goto VaABY; Zk942: if (!($NTBY8 != '')) { goto IWcsu; } goto H37ka; RupUe: } public function extractRules(?string $VoLyz, ?string $QHtFv, string $FaQSt) { goto I7OyN; RX5v_: $this->setCache($k6Dhk, $l5VBM); goto Exc9T; BDBbk: $F0Hdh = $this->createDom($VoLyz); goto UWbpO; AAujr: array_map(function (Rule $Bj1fM, $BBBSd) use($d3hWm) { goto JQ84N; nQugx: S2jCE: goto kWIEk; JQ84N: $YiC76 = false; goto LErbH; ThXa7: if (!$YiC76) { goto S2jCE; } goto fwjX8; LErbH: try { goto qXld0; UcKL0: pp7lp: goto BRNK6; zFaVv: $YiC76 = $c09mp->length > 0; goto UcKL0; YxSWe: $juQiG = $this->buildExpression($C2Sin); goto rSpTo; rSpTo: if (!$juQiG) { goto pp7lp; } goto xD6xs; qXld0: $C2Sin = preg_replace("\57\x3a\72\77\x5b\136\x20\54\x3a\x5d\x2b\x2f", '', $Bj1fM->getSelector()); goto YxSWe; xD6xs: $c09mp = $d3hWm->query($juQiG); goto zFaVv; BRNK6: } catch (Exception $Vggs0) { $YiC76 = true; } goto ThXa7; fwjX8: $this->addRule($BBBSd, $Bj1fM); goto nQugx; kWIEk: }, $l5VBM, array_keys($l5VBM)); goto LhS0f; jH2xy: if ($l5VBM) { goto MrD9w; } goto xw2hX; SfEEg: $this->rules = []; goto BDBbk; Exc9T: MrD9w: goto SfEEg; UWbpO: $d3hWm = new DOMXPath($F0Hdh); goto AAujr; xw2hX: $l5VBM = Util::getRules($QHtFv); goto RX5v_; I7OyN: $k6Dhk = md5($FaQSt); goto RTuGr; RTuGr: $l5VBM = $this->getCache($k6Dhk); goto jH2xy; LhS0f: } private function parseProperties(string $C2Sin, array $vw17N) { $FI5Xk = Util::properties2string($vw17N); return "{$C2Sin}\x7b{$FI5Xk}\x7d"; } public function compileStyles(array $Mx1kI = [], ?string $lnEXp = null) { goto FjBlG; FjBlG: $XKqYs = $lnEXp ? $lnEXp : ''; goto JPkE2; JPkE2: $Mx1kI = $this->prepareRules($Mx1kI); goto F88uX; F88uX: return $XKqYs . join('', array_map(function ($i9bFH) { goto ilBH9; TZP2a: $XZohm = reset($i9bFH); goto w6X3O; ilBH9: $NTBY8 = key($i9bFH); goto TZP2a; w6X3O: return $this->parseMediaToString($NTBY8, $XZohm); goto mwsuF; mwsuF: }, $Mx1kI)); goto UToTu; UToTu: } }
