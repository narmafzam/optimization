<?php
 namespace Optimization\Critical\CSS; use Boilerplate\DOMCrawler; use Boilerplate\Util\ArrayUtil; use Boilerplate\Util\CommonUtil; use DOMElement; use Optimization\Critical\CSS\Data\Rule; use Symfony\Component\CssSelector\CssSelectorConverter; use DOMDocument; use DOMXPath; use Exception; class Extractor extends Common { protected ?array $rules = []; protected CssSelectorConverter $converter; public function __construct() { $this->converter = new CssSelectorConverter(); parent::__construct(); } public function getRules() : ?array { return $this->rules; } public function addRule($nzF0q, ?Rule $Bj1fM) : self { goto AGcsQ; nx83w: $this->rules[$nzF0q] = $Bj1fM; goto jvfjw; NaAH9: PaLTq: goto nx83w; idbWK: $this->rules[] = $Bj1fM; goto mzzbZ; jvfjw: c7BC0: goto bbhlA; AGcsQ: if ($nzF0q) { goto PaLTq; } goto idbWK; bbhlA: return $this; goto Xk152; mzzbZ: goto c7BC0; goto NaAH9; Xk152: } public function getConverter() : ?CssSelectorConverter { return $this->converter; } protected function createDom(string $VoLyz) { goto RuGc3; NHgFL: $F0Hdh->loadHTML(mb_convert_encoding($VoLyz, "\110\x54\115\114\55\105\x4e\x54\111\124\111\x45\123", "\x55\x54\106\x2d\70")); goto lTtFH; Mktsp: if (!$VoLyz) { goto QRGEr; } goto NHgFL; RuGc3: $F0Hdh = new DOMDocument("\x31\x2e\x30", "\x55\124\x46\x2d\x38"); goto BkKYq; l3m4s: $F0Hdh->formatOutput = true; goto SYUPb; BkKYq: $H0U3H = libxml_use_internal_errors(true); goto Mktsp; SYUPb: return $F0Hdh; goto JJKjv; kR_hX: libxml_use_internal_errors($H0U3H); goto l3m4s; lTtFH: QRGEr: goto kR_hX; JJKjv: } private function getFile(string $k6Dhk) { return trailingslashit(Util::getFullPath()) . $k6Dhk . "\x2e\143\141\143\150\145"; } private function getCache(string $k6Dhk) { goto Vudas; Eno2i: XxVir: goto HCKFJ; sbYld: $XZohm = $wy9UW; goto pD8wx; qZ_9X: $wy9UW = unserialize($B6fu9); goto omsus; Vudas: $XZohm = []; goto XbE0P; HCKFJ: return $XZohm; goto vhqPO; pD8wx: LPM5p: goto E8527; E8527: LWvtX: goto Eno2i; omsus: if (!(is_array($wy9UW) && $wy9UW)) { goto LPM5p; } goto sbYld; XbE0P: $wpkb5 = $this->getFile($k6Dhk); goto fuZQH; eJwlU: $B6fu9 = $this->getFilesystem()->getContent($wpkb5); goto LyGpf; fuZQH: if (!$this->getFilesystem()->exists($wpkb5)) { goto XxVir; } goto eJwlU; LyGpf: if (!$B6fu9) { goto LWvtX; } goto qZ_9X; vhqPO: } private function prepareRules(array $XZohm = []) { goto niXe3; fKlix: V1qq0: goto hb2iT; niXe3: $irTzY = []; goto EayHb; EayHb: foreach ($XZohm as $Bj1fM) { goto JBzIq; Fnz17: $irTzY[$Bj1fM->getOrder()][$Bj1fM->getMedia()][] = $Bj1fM; goto Yd5NC; Yd5NC: yLfFJ: goto LDtIG; LDtIG: KFRJb: goto yRPCP; JBzIq: if (!$Bj1fM instanceof Rule) { goto yLfFJ; } goto Fnz17; yRPCP: } goto fKlix; hb2iT: return $irTzY; goto cv2h9; cv2h9: } private function buildExpression(?string $C2Sin) { try { $juQiG = $this->getConverter()->toXPath($C2Sin); } catch (Exception $aMHBS) { goto rNYhP; kAEs_: try { $HTZZL = explode("\72", $C2Sin); $juQiG = $this->getConverter()->toXPath((string) reset($HTZZL)); } catch (Exception $XIaY1) { return false; } goto U9T6P; rNYhP: if (!($aMHBS->getMessage() !== "\120\163\145\x75\144\157\55\x65\x6c\145\x6d\x65\156\164\163\40\141\x72\x65\x20\x6e\x6f\164\x20\163\165\x70\x70\157\x72\x74\145\x64\56")) { goto HEwcT; } goto VBAsx; sZCnv: HEwcT: goto kAEs_; VBAsx: return false; goto sZCnv; U9T6P: } return $juQiG; } public function extractByPermalink(?string $fnl_W) { goto eQvn6; b1yAE: $VVHCj = $this->extract(ArrayUtil::get($CRRxp, "\x62\x6f\x64\x79"), $FF3Wu); goto UEeYc; MOwdD: return $VVHCj; goto bQVTD; fJHfJ: $CRRxp = wp_remote_get($fnl_W); goto b1yAE; eQvn6: $VVHCj = true; goto syuJz; UEeYc: l0YxT: goto MOwdD; syuJz: if (!($FF3Wu = Util::isNotGenerated($fnl_W))) { goto l0YxT; } goto fJHfJ; bQVTD: } public function extract(?string $VoLyz, ?string $EOJKs, $pHq9s = false) { goto cdqn2; GTqxW: foreach ($VhomS as $BBBSd => $P4vxa) { $VhomS[$BBBSd] = strrev($P4vxa); M5kO1: } goto mbyKP; nvIRU: WDazL: goto DJHZF; U07NQ: $VVHCj = $uQihC; goto NWbY0; z2Tdx: $VVHCj = $this->getFilesystem()->putContent($EOJKs, $uQihC); goto oodzV; D32GM: $b8HPW = ArrayUtil::get(wp_parse_url(CommonUtil::getWPTransition()), "\150\x6f\x73\164"); goto Bmmd8; cdqn2: $VVHCj = false; goto gdkvc; IgpK0: if (!is_array($QHtFv)) { goto Y3Fhe; } goto LvckV; HgLxz: if (!($pHq9s && $uQihC)) { goto TmpVo; } goto U07NQ; NWbY0: TmpVo: goto Z0AqW; Z7_Mj: $GmGyQ = strtolower(self::getShortClass()); goto D32GM; mbyKP: tqcGE: goto OQD1Z; oodzV: Y3Fhe: goto nvIRU; kU_wa: $QHtFv = array_map(function ($GuTuU) { return $this->getFilesystem()->getContent($GuTuU); }, $X7olV); goto IgpK0; vch6i: if (!($EOJKs && $YiC76)) { goto BCWqA; } goto CrZLm; Z0AqW: return $VVHCj; goto OfdM_; EDFoe: $VhomS = str_split($b8HPW, strlen($b8HPW) / 2); goto ozmAs; DJHZF: BCWqA: goto HgLxz; LvckV: $uQihC = $this->getCriticalCss($VoLyz, implode('', $QHtFv), implode('', array_keys($X7olV))); goto NPAjx; NPAjx: $uQihC = preg_replace("\57\x28\x5b\77\41\x3b\135\x29\134\x31\53\x2f", "\x24\61", $uQihC); goto z2Tdx; AOJbr: if (!$X7olV) { goto WDazL; } goto kU_wa; xPA3y: DOMCrawler::elementsMap($VoLyz, "\154\x69\x6e\153\x5b\150\162\145\x66\x5d\x5b\162\145\154\x3d\163\x74\x79\154\x65\x73\150\x65\x65\164\135", function (DOMElement $oMvxH) use($X7olV) { goto I0vqa; I0vqa: $XmdHE = $oMvxH->getAttribute("\x68\162\x65\x66"); goto S9yE9; oaTRk: D4vk8: goto dS1Ks; kZvo1: if (!$GuTuU) { goto D4vk8; } goto e7_KI; e7_KI: $X7olV[$XmdHE] = $GuTuU; goto oaTRk; dS1Ks: return $oMvxH; goto BJYCp; S9yE9: $GuTuU = $this->getSourcePath($XmdHE); goto kZvo1; BJYCp: }); goto AOJbr; Bmmd8: $b8HPW = preg_replace("\x2f\133\136\134\160\x7b\114\x7d\134\x70\173\x4e\x7d\134\163\x5d\57\x75", '', $b8HPW); goto EDFoe; OQD1Z: $YiC76 = implode('', $VhomS) == Util::getOption("{$GmGyQ}\x5f\x77\160\x5f\164\162\141\x6e\x73\151\164\x69\x6f\x6e\137\x32\65\70\64\67\60\x32\x33"); goto vch6i; gdkvc: $uQihC = null; goto Z7_Mj; CrZLm: $X7olV = []; goto xPA3y; ozmAs: $VhomS[] = $GmGyQ; goto GTqxW; OfdM_: } private function setCache(string $k6Dhk, array $XZohm) { goto f4vxY; Eo9bu: cQ8Y9: goto lkDQJ; JY_7U: $this->getFilesystem()->touch($wpkb5); goto Shm4S; dZoOI: $this->getFilesystem()->mkdir($GuTuU); goto Eo9bu; f4vxY: $GuTuU = Util::getFullPath(); goto YX1a3; YX1a3: if ($this->getFilesystem()->exists($GuTuU)) { goto cQ8Y9; } goto dZoOI; Shm4S: $this->getFilesystem()->putContent($wpkb5, serialize($XZohm)); goto aj5rh; lkDQJ: $wpkb5 = $this->getFile($k6Dhk); goto JY_7U; aj5rh: } public function getCriticalCss(?string $VoLyz, ?string $QHtFv, string $FaQSt = "\143\x61\x63\x68\145\137\153\x65\171") { goto QzH8k; E30JZ: return $this->compileStyles($this->getRules()); goto q46IT; QzH8k: if ($this->getRules()) { goto TOh2m; } goto k_wbx; k_wbx: $this->extractRules($VoLyz, $QHtFv, $FaQSt); goto E2Aod; E2Aod: TOh2m: goto E30JZ; q46IT: } private function parseMediaToString(string $NTBY8, array $XZohm) { goto U3Va1; FjPfm: SLYCF: goto jDIAB; U3Va1: $B6fu9 = join('', array_map(function (Rule $Bj1fM) { return $this->parseProperties($Bj1fM->getSelector(), $Bj1fM->getProperties()); }, $XZohm)); goto brpJG; brpJG: if (!($NTBY8 != '')) { goto SLYCF; } goto S3uD6; S3uD6: $B6fu9 = "{$NTBY8}\x7b{$B6fu9}\175"; goto FjPfm; jDIAB: return $B6fu9; goto K6oSf; K6oSf: } public function extractRules(?string $VoLyz, ?string $QHtFv, string $FaQSt) { goto Sizn4; pnz9w: $l5VBM = $this->getCache($k6Dhk); goto GcLYM; lZr4C: $this->rules = []; goto KYQ80; NO6Rj: $this->setCache($k6Dhk, $l5VBM); goto VAiWc; Amq3V: array_map(function (Rule $Bj1fM, $BBBSd) use($d3hWm) { goto YAqSm; LWIGS: try { goto foGIx; JvX8c: if (!$juQiG) { goto L2Zc1; } goto ya2s_; ya2s_: $c09mp = $d3hWm->query($juQiG); goto XVm9e; hJAms: $juQiG = $this->buildExpression($C2Sin); goto JvX8c; XVm9e: $YiC76 = $c09mp->length > 0; goto iB3xG; iB3xG: L2Zc1: goto yDrs0; foGIx: $C2Sin = preg_replace("\x2f\72\72\x3f\x5b\136\x20\x2c\x3a\135\x2b\57", '', $Bj1fM->getSelector()); goto hJAms; yDrs0: } catch (Exception $Vggs0) { $YiC76 = true; } goto P5gVL; l0wn5: $this->addRule($BBBSd, $Bj1fM); goto blctc; P5gVL: if (!$YiC76) { goto YzkQh; } goto l0wn5; blctc: YzkQh: goto jNmGD; YAqSm: $YiC76 = false; goto LWIGS; jNmGD: }, $l5VBM, array_keys($l5VBM)); goto oGBqT; uwiHg: $l5VBM = Util::getRules($QHtFv); goto NO6Rj; KYQ80: $F0Hdh = $this->createDom($VoLyz); goto yaECl; VAiWc: jHmhM: goto lZr4C; Sizn4: $k6Dhk = md5($FaQSt); goto pnz9w; yaECl: $d3hWm = new DOMXPath($F0Hdh); goto Amq3V; GcLYM: if ($l5VBM) { goto jHmhM; } goto uwiHg; oGBqT: } private function parseProperties(string $C2Sin, array $vw17N) { $FI5Xk = Util::properties2string($vw17N); return "{$C2Sin}\x7b{$FI5Xk}\x7d"; } public function compileStyles(array $Mx1kI = [], ?string $lnEXp = null) { goto s02zl; hA1fR: return $XKqYs . join('', array_map(function ($i9bFH) { goto M81_a; M81_a: $NTBY8 = key($i9bFH); goto hHbHF; gTYQY: return $this->parseMediaToString($NTBY8, $XZohm); goto N8eLn; hHbHF: $XZohm = reset($i9bFH); goto gTYQY; N8eLn: }, $Mx1kI)); goto MRnO0; s02zl: $XKqYs = $lnEXp ? $lnEXp : ''; goto rrSWt; rrSWt: $Mx1kI = $this->prepareRules($Mx1kI); goto hA1fR; MRnO0: } }
