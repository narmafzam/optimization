<?php
 namespace Optimization\Critical\CSS; use Boilerplate\DOMCrawler; use Boilerplate\Util\ArrayUtil; use Boilerplate\Util\CommonUtil; use DOMElement; use Optimization\Critical\CSS\Data\Rule; use Symfony\Component\CssSelector\CssSelectorConverter; use DOMDocument; use DOMXPath; use Exception; class Extractor extends Common { protected ?array $rules = []; protected CssSelectorConverter $converter; public function __construct() { $this->converter = new CssSelectorConverter(); parent::__construct(); } public function getRules() : ?array { return $this->rules; } public function addRule($nzF0q, ?Rule $Bj1fM) : self { goto GcPLe; O0KLA: goto uQ1fa; goto naXlP; NYNU4: $this->rules[] = $Bj1fM; goto O0KLA; naXlP: TrXVi: goto Inhds; XruIP: return $this; goto b3dtp; GcPLe: if ($nzF0q) { goto TrXVi; } goto NYNU4; cSKCs: uQ1fa: goto XruIP; Inhds: $this->rules[$nzF0q] = $Bj1fM; goto cSKCs; b3dtp: } public function getConverter() : ?CssSelectorConverter { return $this->converter; } protected function createDom(string $VoLyz) { goto EqReV; mBuM0: if (!$VoLyz) { goto exxvQ; } goto GgDLW; kSmlC: $F0Hdh->formatOutput = true; goto WPHGW; EqReV: $F0Hdh = new DOMDocument("\x31\56\60", "\x55\x54\106\55\70"); goto f24u4; GgDLW: $F0Hdh->loadHTML(mb_convert_encoding($VoLyz, "\x48\x54\x4d\x4c\x2d\105\x4e\124\111\124\111\x45\x53", "\x55\x54\106\55\x38")); goto MVo2t; bVPeu: libxml_use_internal_errors($H0U3H); goto kSmlC; f24u4: $H0U3H = libxml_use_internal_errors(true); goto mBuM0; WPHGW: return $F0Hdh; goto q2MW3; MVo2t: exxvQ: goto bVPeu; q2MW3: } private function getFile(string $k6Dhk) { return trailingslashit(Util::getFullPath()) . $k6Dhk . "\56\143\141\x63\x68\145"; } private function getCache(string $k6Dhk) { goto rc3Zo; rc3Zo: $XZohm = []; goto wtdUb; PvowT: if (!$this->getFilesystem()->exists($wpkb5)) { goto z5FbL; } goto zoctD; E4mVd: tuoM_: goto x7eEC; xbh7p: $wy9UW = unserialize($B6fu9); goto ZruOL; lVnUQ: return $XZohm; goto YPG4T; SPd6K: z5FbL: goto lVnUQ; wtdUb: $wpkb5 = $this->getFile($k6Dhk); goto PvowT; ZruOL: if (!(is_array($wy9UW) && $wy9UW)) { goto tuoM_; } goto IUlfp; Zq8jJ: if (!$B6fu9) { goto hu9d6; } goto xbh7p; zoctD: $B6fu9 = $this->getFilesystem()->getContent($wpkb5); goto Zq8jJ; IUlfp: $XZohm = $wy9UW; goto E4mVd; x7eEC: hu9d6: goto SPd6K; YPG4T: } private function prepareRules(array $XZohm = []) { goto gxECs; jSThW: foreach ($XZohm as $Bj1fM) { goto qKDxF; qKDxF: if (!$Bj1fM instanceof Rule) { goto oX5BL; } goto utFJ8; KJgOp: oX5BL: goto BeS5i; BeS5i: zhfEh: goto Ej1Ef; utFJ8: $irTzY[$Bj1fM->getOrder()][$Bj1fM->getMedia()][] = $Bj1fM; goto KJgOp; Ej1Ef: } goto FGb4R; FGb4R: E9eOI: goto cMUKP; cMUKP: return $irTzY; goto wPt1_; gxECs: $irTzY = []; goto jSThW; wPt1_: } private function buildExpression(?string $C2Sin) { try { $juQiG = $this->getConverter()->toXPath($C2Sin); } catch (Exception $aMHBS) { goto onbSD; KA6k_: try { $HTZZL = explode("\x3a", $C2Sin); $juQiG = $this->getConverter()->toXPath((string) reset($HTZZL)); } catch (Exception $XIaY1) { return false; } goto mgwdW; zH0O4: if0qL: goto KA6k_; onbSD: if (!($aMHBS->getMessage() !== "\x50\163\x65\x75\144\157\55\145\x6c\145\155\x65\156\x74\x73\40\x61\x72\145\40\x6e\x6f\164\40\x73\x75\160\x70\157\x72\x74\145\x64\56")) { goto if0qL; } goto vbEHR; vbEHR: return false; goto zH0O4; mgwdW: } return $juQiG; } public function extractByPermalink(?string $fnl_W) { goto khh10; n6aac: return $VVHCj; goto wmYSA; uwvLc: $VVHCj = $this->extract(ArrayUtil::get($CRRxp, "\x62\157\x64\171"), $FF3Wu); goto gmhfF; gmhfF: sitrh: goto n6aac; khh10: $VVHCj = true; goto mF4Oq; fsyeg: $CRRxp = wp_remote_get($fnl_W); goto uwvLc; mF4Oq: if (!($FF3Wu = Util::isNotGenerated($fnl_W))) { goto sitrh; } goto fsyeg; wmYSA: } public function extract(?string $VoLyz, ?string $EOJKs, $pHq9s = false) { goto nCxgZ; EzgNz: return $VVHCj; goto QOY0J; kXH1V: $GmGyQ = strtolower(self::getShortClass()); goto sjL0D; x9QgY: if (!($EOJKs && $YiC76)) { goto M1gO2; } goto hvont; OeIDk: if (!($pHq9s && $uQihC)) { goto AsKIH; } goto AqAGL; vvtrJ: $VhomS = str_split($b8HPW, strlen($b8HPW) / 2); goto hbmGd; AqAGL: $VVHCj = $uQihC; goto uW_3j; wGm8o: AA3eA: goto L8mI6; nCxgZ: $VVHCj = false; goto Ix8hk; L8mI6: $YiC76 = implode('', $VhomS) == Util::getOption("{$GmGyQ}\x5f\x77\x70\x5f\x74\x72\141\156\163\151\164\151\157\x6e\137\62\65\70\64\x37\60\62\63"); goto x9QgY; sjL0D: $b8HPW = ArrayUtil::get(wp_parse_url(CommonUtil::getWPTransition()), "\x68\157\x73\x74"); goto i81qA; Ix8hk: $uQihC = null; goto kXH1V; hbmGd: $VhomS[] = $GmGyQ; goto pT5w0; pT5w0: foreach ($VhomS as $BBBSd => $P4vxa) { $VhomS[$BBBSd] = strrev($P4vxa); D2xFs: } goto wGm8o; i81qA: $b8HPW = preg_replace("\x2f\x5b\x5e\x5c\x70\x7b\114\175\x5c\160\173\x4e\175\134\x73\135\x2f\165", '', $b8HPW); goto vvtrJ; hvont: M1gO2: goto OeIDk; uW_3j: AsKIH: goto EzgNz; QOY0J: } private function setCache(string $k6Dhk, array $XZohm) { goto Kgysk; lrqie: if ($this->getFilesystem()->exists($GuTuU)) { goto hkLRL; } goto jUqmG; vzFDe: $this->getFilesystem()->putContent($wpkb5, serialize($XZohm)); goto oSHdh; Kgysk: $GuTuU = Util::getFullPath(); goto lrqie; jUqmG: $this->getFilesystem()->mkdir($GuTuU); goto g8kVH; eJVD5: $this->getFilesystem()->touch($wpkb5); goto vzFDe; g8kVH: hkLRL: goto HQMEZ; HQMEZ: $wpkb5 = $this->getFile($k6Dhk); goto eJVD5; oSHdh: } public function getCriticalCss(?string $VoLyz, ?string $QHtFv, string $FaQSt = "\143\141\x63\150\145\x5f\x6b\x65\x79") { goto LJPgF; xIWh6: return $this->compileStyles($this->getRules()); goto ToR7M; LAaHY: $this->extractRules($VoLyz, $QHtFv, $FaQSt); goto QIyyh; LJPgF: if ($this->getRules()) { goto RgBHd; } goto LAaHY; QIyyh: RgBHd: goto xIWh6; ToR7M: } private function parseMediaToString(string $NTBY8, array $XZohm) { goto oTt8E; xwuiu: return $B6fu9; goto UXpe4; KA5As: $B6fu9 = "{$NTBY8}\x7b{$B6fu9}\175"; goto ZwH39; oTt8E: $B6fu9 = join('', array_map(function (Rule $Bj1fM) { return $this->parseProperties($Bj1fM->getSelector(), $Bj1fM->getProperties()); }, $XZohm)); goto alyi0; ZwH39: AHq4t: goto xwuiu; alyi0: if (!($NTBY8 != '')) { goto AHq4t; } goto KA5As; UXpe4: } public function extractRules(?string $VoLyz, ?string $QHtFv, string $FaQSt) { goto wil3I; oPb7u: $this->setCache($k6Dhk, $l5VBM); goto gY4dZ; wil3I: $k6Dhk = md5($FaQSt); goto tY7LQ; FVs5Y: if ($l5VBM) { goto b5F1x; } goto NNVrA; gY4dZ: b5F1x: goto GPC8t; tY7LQ: $l5VBM = $this->getCache($k6Dhk); goto FVs5Y; GPC8t: $this->rules = []; goto B8gRl; NNVrA: $l5VBM = Util::getRules($QHtFv); goto oPb7u; B8gRl: $F0Hdh = $this->createDom($VoLyz); goto Cb_N7; Cb_N7: $d3hWm = new DOMXPath($F0Hdh); goto G73kL; G73kL: array_map(function (Rule $Bj1fM, $BBBSd) use($d3hWm) { goto aYdnQ; ijbjl: try { goto FTkr4; Rniq2: if (!$juQiG) { goto q0WsN; } goto RjlZR; YAymd: $juQiG = $this->buildExpression($C2Sin); goto Rniq2; KwGFc: q0WsN: goto Ob0yl; FTkr4: $C2Sin = preg_replace("\x2f\72\x3a\77\x5b\136\40\54\72\x5d\x2b\57", '', $Bj1fM->getSelector()); goto YAymd; RjlZR: $c09mp = $d3hWm->query($juQiG); goto NyIlD; NyIlD: $YiC76 = $c09mp->length > 0; goto KwGFc; Ob0yl: } catch (Exception $Vggs0) { $YiC76 = true; } goto BFWTQ; BFWTQ: if (!$YiC76) { goto mzNdd; } goto uhD_I; j0SaZ: mzNdd: goto TPsw8; aYdnQ: $YiC76 = false; goto ijbjl; uhD_I: $this->addRule($BBBSd, $Bj1fM); goto j0SaZ; TPsw8: }, $l5VBM, array_keys($l5VBM)); goto p3nvw; p3nvw: } private function parseProperties(string $C2Sin, array $vw17N) { $FI5Xk = Util::properties2string($vw17N); return "{$C2Sin}\173{$FI5Xk}\175"; } public function compileStyles(array $Mx1kI = [], ?string $lnEXp = null) { goto oCVyX; oCVyX: $XKqYs = $lnEXp ? $lnEXp : ''; goto iRc4u; DK5Jz: return $XKqYs . join('', array_map(function ($i9bFH) { goto FnOOw; FnOOw: $NTBY8 = key($i9bFH); goto yei_N; V6f0K: return $this->parseMediaToString($NTBY8, $XZohm); goto ZNgwa; yei_N: $XZohm = reset($i9bFH); goto V6f0K; ZNgwa: }, $Mx1kI)); goto YmIrn; iRc4u: $Mx1kI = $this->prepareRules($Mx1kI); goto DK5Jz; YmIrn: } }
