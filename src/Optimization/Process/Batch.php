<?php
 namespace Optimization\Process; use Boilerplate\Process\Background; use Boilerplate\Util\AjaxUtil; use Boilerplate\Util\ArrayUtil; use Boilerplate\Util\CommonUtil; use Boilerplate\Util\PageUtil; use Optimization\Notice; use Optimization\Util\Util; class Batch extends Background { const OPTIMIZATION = "\157\160\164\151\155\x69\172\x61\164\151\157\x6e\x5f"; const OPTIMIZATION_URLS = self::OPTIMIZATION . "\x75\x72\x6c\163"; const OPTIMIZATION_STARTED = self::OPTIMIZATION . "\163\164\x61\162\164\145\x64"; const RUNNING_PROCESS_TRANSITION = self::OPTIMIZATION . "\x72\165\156\156\x69\156\147\137\x70\x72\157\143\x65\x73\163"; public function __construct() { $this->action = "\x6f\160\x74\151\x6d\x69\172\x61\164\151\157\x6e\137\142\141\164\x63\150\x5f\x70\x72\157\143\145\163\163"; parent::__construct(); } public function addActions() : self { $this->addAction("\x61\144\x6d\151\x6e\137\151\156\151\x74", [$this, "\141\x64\155\x69\156\111\x6e\151\164"], 0, 99)->addAction("\x61\x66\164\145\x72\x5f\157\160\164\151\x6d\x69\x7a\x61\164\151\x6f\x6e\x5f\143\154\145\x61\156\137\160\157\x73\x74", [$this, "\x6f\156\103\x6c\x65\141\156\x50\x6f\x73\164"], 2, 99)->addAction("\141\x66\164\x65\x72\137\157\x70\164\151\x6d\x69\x7a\x61\x74\x69\x6f\x6e\x5f\143\x6c\145\x61\x6e\x5f\x64\157\x6d\x61\151\156", [$this, "\162\145\163\145\164\x50\x72\157\143\145\x73\x73"], 0, 99); return parent::addActions(); } public function onCleanPost($post, $permalinks) { goto K0Ux1; gXikK: if (!(join('', $permalinks) !== join('', $saved))) { goto sAnd3; } goto UGjCF; mRDo0: $saved = (array) Util::getOption(self::OPTIMIZATION_URLS, []); goto gXikK; UGjCF: $permalinks = array_unique(array_merge($permalinks, $saved), SORT_REGULAR); goto lpS8D; K0Ux1: $permalinks[] = PageUtil::getFrontPagePermalink(); goto mRDo0; Qilyh: sAnd3: goto TBelw; lpS8D: Util::updateOption(self::OPTIMIZATION_URLS, $permalinks); goto Qilyh; TBelw: } public function resetProcess() { $this->complete(); Util::deleteOption(self::OPTIMIZATION_STARTED); } protected function complete() { goto v0BAX; IYOD0: Util::deleteOption(self::OPTIMIZATION_URLS); goto n80Bk; VxOcZ: wp_cache_delete(self::RUNNING_PROCESS_TRANSITION, "\164\x72\141\156\163\x69\x65\x6e\x74"); goto N81az; v0BAX: parent::complete(); goto IYOD0; n80Bk: delete_transient(self::RUNNING_PROCESS_TRANSITION); goto VxOcZ; N81az: } public function adminInit() { goto wHQu7; cIpdG: LQyrl: goto QIrSk; kuJLw: Util::updateOption(self::OPTIMIZATION_STARTED, true); goto cIpdG; yU1zq: if (CommonUtil::getOption(self::OPTIMIZATION_STARTED, false)) { goto LQyrl; } goto u0x1U; QIrSk: $this->startOptimization(); goto vAtJe; wHQu7: if (AjaxUtil::isAjax()) { goto dp0tg; } goto yU1zq; vAtJe: dp0tg: goto xM8e0; u0x1U: $this->maybeStartProcess(Util::getPublicPermalinks()); goto kuJLw; xM8e0: } public function startOptimization() { goto K2KN0; IchH8: if (!$permalinks) { goto zGpMb; } goto n2pSQ; K2KN0: $permalinks = Util::getOption(self::OPTIMIZATION_URLS, []); goto IchH8; If01c: zGpMb: goto kD8We; zRr7h: Util::deleteOption(self::OPTIMIZATION_URLS); goto If01c; n2pSQ: $transient = md5(join('', $permalinks)); goto bCkpx; bCkpx: $this->maybeStartProcess($permalinks, $transient); goto zRr7h; kD8We: } public function task($permalink) { goto stShM; sqyDb: if (!is_wp_error($response)) { goto YcDQq; } goto YZR_d; dBUDh: $response = Util::sendOptRequest($permalink); goto sqyDb; uN9Cc: return false; goto pU2Wm; YZR_d: $success = false; goto aQO7f; hW2ih: $this->updateRunningTransient($success); goto arVG7; arVG7: Cb6e3: goto uN9Cc; BTumn: $success = true; goto dBUDh; WM4zL: YcDQq: goto hW2ih; aQO7f: $data["\145\162\162\x6f\x72\x73"] = json_encode($response->errors); goto WM4zL; stShM: if (!$permalink) { goto Cb6e3; } goto BTumn; pU2Wm: } private function updateRunningTransient($successful) { goto SYOZQ; VgiKC: goto EKN4i; goto ynh_D; dgaCQ: EKN4i: goto Qeu2T; is8ef: $transient["\163\x75\143\x63\x65\x73\x73"] = ++$success; goto dgaCQ; SYOZQ: $key = self::RUNNING_PROCESS_TRANSITION; goto UZHzN; unE1t: if ($successful) { goto cd781; } goto mZ_id; yec5r: $failed = (int) ArrayUtil::get($transient, "\146\x61\x69\x6c\x65\x64", 0); goto sYc3d; UZHzN: $transient = get_transient($key); goto nKeWa; sYc3d: $success = (int) ArrayUtil::get($transient, "\x73\165\x63\143\145\x73\163", 0); goto unE1t; mZ_id: $transient["\x66\141\x69\x6c\x65\144"] = ++$failed; goto VgiKC; Qeu2T: set_transient($key, $transient, $this->getExpire($total)); goto jBYkw; nKeWa: $total = (int) ArrayUtil::get($transient, "\x74\157\164\x61\154", 0); goto yec5r; ynh_D: cd781: goto is8ef; jBYkw: } public function generationRunningNotice() { goto IMnml; yX9yy: $success = ArrayUtil::get($transient, "\163\165\x63\x63\x65\x73\163", 0); goto nfghH; nfghH: $failed = ArrayUtil::get($transient, "\146\141\151\x6c\x65\144", 0); goto vLqXx; xUCFE: goto RpNXj; goto tAdgk; UFPLs: if ($transient && $total) { goto dZIFx; } goto Ws_aI; Ws_aI: delete_transient(self::RUNNING_PROCESS_TRANSITION); goto JhXFn; vLqXx: Notice::info(sprintf(__("\117\x70\164\151\x6d\x69\172\141\164\151\157\x6e\40\x70\162\x6f\143\145\x73\x73\x20\x69\163\x20\143\x75\x72\x72\x65\156\x74\154\x79\40\x72\x75\x6e\x6e\151\x6e\x67\72\40\x25\x73\40\x73\165\x63\x63\145\x73\163\40\x61\156\x64\x20\45\163\x20\146\141\151\x6c\x65\x64\40\x6f\146\x20\x25\163\x20\160\141\x67\x65\40\x74\171\160\x65\163\x20\x63\157\x6d\160\x6c\145\164\x65\144\56\40\x28\x52\145\x66\x72\145\163\150\x20\164\x68\151\x73\x20\160\141\x67\x65\x20\x74\x6f\x20\x76\151\145\167\x20\x70\162\x6f\x67\162\145\x73\163\51", OPTIMIZATION_DOMAIN), $success, $failed, $total), "\157\160\x74\151\155\x69\x7a\x61\164\x69\157\156"); goto bMQ4g; JhXFn: wp_cache_delete(self::RUNNING_PROCESS_TRANSITION, "\164\162\x61\x6e\x73\x69\145\156\x74"); goto xUCFE; IMnml: $transient = get_transient(self::RUNNING_PROCESS_TRANSITION); goto jNYfV; bMQ4g: RpNXj: goto h4Yx1; tAdgk: dZIFx: goto yX9yy; jNYfV: $total = ArrayUtil::get($transient, "\164\x6f\164\x61\x6c", 0); goto UFPLs; h4Yx1: } public function getExpire($total) { goto LuEhH; kJJuc: $multiple = 1; goto MjOzV; M8BfK: return HOUR_IN_SECONDS * $multiple; goto I_oQ3; izKzd: if (!($multiple < 1)) { goto cWMp1; } goto kJJuc; MjOzV: cWMp1: goto M8BfK; LuEhH: $multiple = $total / 500; goto izKzd; I_oQ3: } public function maybeStartProcess($items = [], ?string $transient = self::RUNNING_PROCESS_TRANSITION) { goto Qv8A9; Qv8A9: if (!($items && $this->applyFilters("\x6f\160\164\x69\155\x69\x7a\141\164\151\x6f\x6e\137\144\x6f\x5f\157\x70\164\151\155\x69\x7a\141\x74\x69\x6f\x6e\137\160\x72\157\x63\145\x73\163", true) && (!$transient || !get_transient($transient)))) { goto JMh7R; } goto rPMFx; lfRHy: $total = count($this->getData()); goto TEMA4; em3zK: JMh7R: goto RDBxV; RxyL3: if (!$transient) { goto qzJCY; } goto lfRHy; TEMA4: $data = ["\164\x6f\x74\141\154" => $total, "\146\x61\151\154\x65\x64" => 0, "\x73\165\x63\143\x65\163\163" => 0]; goto xEmE0; xEmE0: set_transient($transient, $data, $this->getExpire($total)); goto x9gnq; x9gnq: qzJCY: goto ZeRSb; ZeRSb: $this->save()->dispatch(); goto XhmQB; rPMFx: array_map([$this, "\x70\x75\163\x68\x32\161\165\x65\x75\145"], $items); goto RxyL3; XhmQB: Notice::info(__("\x4f\160\x74\x69\155\151\172\141\x74\x69\157\156\40\x70\x72\x6f\x63\x65\163\163\x20\x69\163\x20\x63\x75\162\x72\x65\x6e\x74\154\171\x20\162\x75\156\x6e\x69\156\x67\56", OPTIMIZATION_DOMAIN), "\157\160\164\x69\x6d\x69\172\141\x74\x69\x6f\156"); goto em3zK; RDBxV: } }
